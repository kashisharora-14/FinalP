<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=yes, maximum-scale=5.0">
    <title>Dashboard - VetTrack Ai</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav id="customNavbar" class="navbar navbar-expand-lg navbar-light py-3 shadow-sm rounded">
        <div class="container">
            <a class="navbar-brand fw-bold fs-4" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='paw.webp') }}" alt="" style="height: 50px; width: auto;">
                VetTrack AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="navigateToSection('features')">Services</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="navigateToSection('about')">About</a></li>

                    {% if user %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>{{ user.full_name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}" onclick="clearReminderSession()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="btn btn-dark rounded-pill ms-3 px-4" href="{{ url_for('login') }}">Login</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>


    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-white sidebar collapse border-end">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item mb-1">
                            <a class="nav-link active rounded" href="#" data-section="overview">
                                <i class="fas fa-tachometer-alt me-2"></i>Overview
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link rounded" href="#" data-section="pets">
                                <i class="fas fa-paw me-2"></i>My Pets
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link rounded" href="{{ url_for('symptom') }}">
                                <i class="fas fa-stethoscope me-2"></i>Symptom Checker
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link rounded" href="{{ url_for('image') }}">
                                <i class="fas fa-camera me-2"></i>Photo Analysis
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link rounded" href="{{ url_for('history') }}">
                                <i class="fas fa-history me-2"></i>Health History
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a class="nav-link rounded" href="{{ url_for('wellness') }}">
                                <i class="fas fa-calendar-alt me-2"></i>Wellness
                            </a>
                        </li>
                    </ul>

                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white py-3">
                            <h6 class="m-0 fw-semibold">Quick Actions</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a href="{{ url_for('symptom') }}"
                                    class="list-group-item list-group-item-action border-0 py-3">
                                    <i class="fas fa-stethoscope me-3 text-primary"></i>Check Symptoms
                                </a>
                                <a href="{{ url_for('image') }}"
                                    class="list-group-item list-group-item-action border-0 py-3">
                                    <i class="fas fa-camera me-3 text-success"></i>Analyze Photo
                                </a>
                                <a href="{{ url_for('wellness') }}"
                                    class="list-group-item list-group-item-action border-0 py-3">
                                    <i class="fas fa-calendar-plus me-3 text-warning"></i>Add Reminder
                                </a>
                                <button class="list-group-item list-group-item-action border-0 py-3"
                                    onclick="startConsultation()">
                                    <i class="fas fa-video me-3 text-info"></i>Start Consultation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Overview Section -->
                <div id="overview-section" class="section">
                    <div
                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard Overview</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#addPetModal">
                                <i class="fas fa-plus me-1"></i>Add New Pet
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100 hover-lift">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small fw-medium text-uppercase mb-1">Total Pets</div>
                                            <div class="h3 mb-0 fw-bold text-primary" id="totalPets">0</div>
                                        </div>
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-paw"></i>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100 hover-lift">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small fw-medium text-uppercase mb-1">Health Records
                                            </div>
                                            <div class="h3 mb-0 fw-bold text-success" id="totalRecords">0</div>
                                        </div>
                                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-chart-line"></i>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100 hover-lift">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small fw-medium text-uppercase mb-1">Pending
                                                Reminders</div>
                                            <div class="h3 mb-0 fw-bold text-warning" id="pendingReminders">0</div>
                                            <button class="btn btn-sm btn-outline-warning mt-2" onclick="announceRemindersManually()" id="announceBtn" style="display: none;">
                                                <i class="fas fa-volume-up me-1"></i>Announce & Go to Wellness
                                            </button>
                                        </div>
                                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-bell"></i>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100 hover-lift">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small fw-medium text-uppercase mb-1">Consultations
                                            </div>
                                            <div class="h3 mb-0 fw-bold text-info">Available</div>
                                        </div>
                                        <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-video"></i>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="card shadow-sm mb-4">
                        <div
                            class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-history me-2"></i>Recent Health History
                                {% if pagination.pages > 1 %}
                                <small class="text-white-50">(Page {{ pagination.page }} of {{ pagination.pages
                                    }})</small>
                                {% endif %}
                            </h6>
                            <a href="{{ url_for('history') }}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-eye me-1"></i>View Full History
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Pet</th>
                                            <th>Date</th>
                                            <th>Symptoms</th>
                                            <th>Diagnosis</th>
                                            <th>Recommendations</th>
                                            <th>Urgency</th>
                                        </tr>
                                    </thead>
                                    <tbody id="healthHistoryBody">
                                        {% if health_history %}
                                        {% for record in health_history %}
                                        <tr>
                                            <td>{{ record.pet_name or 'Pet #' ~ record.pet_id }}</td>
                                            <td>{{ record.date.strftime('%m/%d/%Y') if record.date.strftime else
                                                record.date }}</td>
                                            <td>{{ record.symptoms[:50] ~ '...' if record.symptoms|length > 50 else
                                                record.symptoms }}</td>
                                            <td>
                                                {% if record.diagnosis %}
                                                {% if record.diagnosis is string %}
                                                {% if not (record.diagnosis.startswith('Warning:') or '⚠' in
                                                record.diagnosis) %}
                                                <div class="diagnosis-list">
                                                    <span class="text-dark">
                                                        {{ record.diagnosis[:40] ~ '...' if record.diagnosis|length > 40
                                                        else record.diagnosis }}
                                                    </span>
                                                </div>
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                                {% else %}
                                                <div class="diagnosis-list">
                                                    {% set diagnoses = [] %}
                                                    {% for diagnosis in record.diagnosis %}
                                                    {% if not (diagnosis.startswith('Warning:') or '⚠' in diagnosis) %}
                                                    {% set _ = diagnoses.append(diagnosis) %}
                                                    {% endif %}
                                                    {% endfor %}

                                                    {% if diagnoses %}
                                                    {% for diagnosis in diagnoses %}
                                                    <div class="mb-1">
                                                        <span class="text-dark">
                                                            {{ diagnosis[:40] ~ '...' if diagnosis|length > 40 else
                                                            diagnosis }}
                                                        </span>
                                                    </div>
                                                    {% endfor %}
                                                    {% else %}
                                                    <span class="text-muted">—</span>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.recommendation %}
                                                <div class="recommendation-text">
                                                    {{ record.recommendation }}
                                                </div>
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.urgency_level %}
                                                <span class="badge 
                                                            {% if record.urgency_level == 'High' %}bg-danger
                                                            {% elif record.urgency_level == 'Medium' %}bg-warning text-dark
                                                            {% else %}bg-success{% endif %}">
                                                    {{ record.urgency_level }}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-clipboard fa-2x mb-2"></i>
                                                <p>No health history records found.</p>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pagination Controls -->
                        {% if pagination and pagination.pages > 1 %}
                        <div class="card-footer">
                            <nav aria-label="Health history pagination">
                                <ul class="pagination pagination-sm justify-content-center mb-0">
                                    <!-- Previous Page -->
                                    <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                                        <a class="page-link"
                                            href="{{ url_for('dashboard', page=pagination.prev_num) if pagination.has_prev else '#' }}">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </a>
                                    </li>

                                    <!-- Page Numbers -->
                                    {% for page_num in pagination.iter_pages() %}
                                    {% if page_num %}
                                    {% if page_num != pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('dashboard', page=page_num) }}">{{
                                            page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                    {% endfor %}

                                    <!-- Next Page -->
                                    <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                                        <a class="page-link"
                                            href="{{ url_for('dashboard', page=pagination.next_num) if pagination.has_next else '#' }}">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        {% endif %}

                        <!-- View Full History Button -->
                        <div class="text-center mt-3">
                            <a href="{{ url_for('history') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-history me-1"></i>View Complete History
                            </a>
                        </div>
                    </div>


                </div>

                <!-- Pets Section -->
                <div id="pets-section" class="section" style="display: none;">
                    <div
                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">My Pets</h1>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addPetModal">
                            <i class="fas fa-plus me-1"></i>Add New Pet
                        </button>
                    </div>

                    <div id="petsContainer" class="row">
                        <!-- Pets will be loaded here -->
                    </div>
                </div>
            </main>
        </div>
    </div>


    <!-- Add Pet Modal -->
    <div class="modal fade" id="addPetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Pet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPetForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="petName" class="form-label">Pet Name</label>
                            <input type="text" class="form-control" id="petName" required>
                        </div>
                        <div class="mb-3">
                            <label for="petSpecies" class="form-label">Species</label>
                            <select class="form-select" id="petSpecies" required>
                                <option value="">Select species</option>
                                <option value="dog">Dog</option>
                                <option value="cat">Cat</option>
                                <option value="bird">Bird</option>
                                <option value="rabbit">Rabbit</option>
                                <option value="hamster">Hamster</option>
                                <option value="fish">Fish</option>
                                <option value="reptile">Reptile</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="petBreed" class="form-label">Breed</label>
                            <input type="text" class="form-control" id="petBreed" required>
                        </div>
                        <div class="mb-3">
                            <label for="petAge" class="form-label">Age (human years)</label>
                            <input type="number" class="form-control" id="petAge" min="0" max="50" required>
                        </div>
                        <div class="mb-3">
                            <label for="petPhoto" class="form-label">Profile Picture (Optional)</label>
                            <input type="file" class="form-control" id="petPhoto" name="profile_picture"
                                accept="image/*">
                            <div class="form-text">Upload a photo of your pet (JPG, PNG, WebP)</div>
                        </div>
                        <div class="mb-3">
                            <label for="petNotes" class="form-label">Medical Notes</label>
                            <textarea class="form-control" id="petNotes" rows="3"
                                placeholder="Any existing conditions, allergies, or important notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addPet()">Add Pet</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage">
                    Success message here
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // TTS Welcome Greeting
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is a fresh login (user name in session)
            const userName = '{{ session.get("user_name", "") }}';
            if (userName && userName.trim()) {
                // Show loading indicator and start TTS immediately
                const welcomeMessage = `Welcome back, ${userName}! You're now logged into VetTrack AI.`;
                
                // Show a subtle loading indicator
                const loadingToast = document.createElement('div');
                loadingToast.className = 'position-fixed top-0 end-0 p-3';
                loadingToast.style.zIndex = '9999';
                loadingToast.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-body">
                            <i class="fas fa-volume-up text-primary me-2"></i>
                            Playing welcome message...
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingToast);
                
                // Start TTS immediately
                speakText(welcomeMessage).then(() => {
                    // Remove loading indicator after TTS completes
                    setTimeout(() => {
                        if (loadingToast.parentNode) {
                            loadingToast.remove();
                        }
                    }, 2000);
                });
                
                // Clear the session name so it doesn't repeat on refresh
                fetch('/api/clear_welcome_session', { method: 'POST' });
            }
        });
    </script>
    <script>
        // Run on dashboard load
        document.addEventListener('DOMContentLoaded', function () {
            loadDashboardData();
            loadPets('petsContainer');   // default load for My Pets
        });

        // Section navigation
        document.querySelectorAll('.nav-link[data-section]').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const section = this.dataset.section;

                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                // Show/hide sections
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById(section + '-section').style.display = 'block';

                // Load pets when "My Pets" section is opened
                if (section === 'pets') {
                    loadPets('petsContainer');
                }
                // Example: if you add another section later
                if (section === 'my-pets') {
                    loadPets('myPetsContainer');
                }
            });
        });

        // Flag to prevent multiple announcements - use sessionStorage to persist across page loads
        let hasAnnouncedReminders = sessionStorage.getItem('hasAnnouncedReminders') === 'true';

        // Reset flag when page is refreshed or navigated to
        window.addEventListener('beforeunload', function() {
            // Don't reset the flag on page unload - keep it for the session
        });

        // Dashboard counters
        function loadDashboardData() {
            // Pets count
            fetch('/api/get_pets')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalPets').textContent = data.pets.length;
                    }
                });

            // Pending reminders count and announcement
            fetch('/api/get_reminders')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const pending = data.reminders.filter(r => !r.completed).length;
                        document.getElementById('pendingReminders').textContent = pending;
                        
                        // Show/hide announce button based on pending reminders
                        const announceBtn = document.getElementById('announceBtn');
                        if (pending > 0) {
                            announceBtn.style.display = 'inline-block';
                            // Announce pending reminders only once per session
                            if (!hasAnnouncedReminders) {
                                setTimeout(() => {
                                    // Check if no audio is currently playing before announcing
                                    const audioElement = document.querySelector('audio');
                                    if (!audioElement || audioElement.paused) {
                                        announcePendingReminders(data.reminders.filter(r => !r.completed));
                                        hasAnnouncedReminders = true;
                                        sessionStorage.setItem('hasAnnouncedReminders', 'true');
                                    }
                                }, 3000); // 3 second delay
                            }
                        } else {
                            announceBtn.style.display = 'none';
                        }
                    }
                });

            // Health history count
            fetch('/api/get_health_history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalRecords').textContent = data.health_history.length;
                    }
                });
        }

        // Function to announce pending reminders using Murf TTS
        function announcePendingReminders(pendingReminders) {
            if (!pendingReminders || pendingReminders.length === 0) return;
            
            const announcementText = createAnnouncementText(pendingReminders);
            
            // Use Murf TTS to announce the reminders
            speakText(announcementText, { voiceId: 'en-US-natalie' });
        }

        // Manual announcement function
        function announceRemindersManually() {
            const announceBtn = document.getElementById('announceBtn');
            const originalText = announceBtn.innerHTML;
            
            // Set flag to prevent automatic announcement
            hasAnnouncedReminders = true;
            sessionStorage.setItem('hasAnnouncedReminders', 'true');
            
            // Stop any currently playing audio
            const audioElement = document.querySelector('audio');
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            
            fetch('/api/get_reminders')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const pendingReminders = data.reminders.filter(r => !r.completed);
                        if (pendingReminders.length > 0) {
                            // Show announcing message
                            announceBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Announcing...';
                            announceBtn.disabled = true;
                            
                            // Create announcement text
                            const announcementText = createAnnouncementText(pendingReminders);
                            
                            // Announce and wait for completion
                            speakText(announcementText, { voiceId: 'en-US-natalie' }).then(() => {
                                // Wait for audio to finish playing
                                const audioElement = document.querySelector('audio');
                                if (audioElement) {
                                    audioElement.addEventListener('ended', function onEnded() {
                                        audioElement.removeEventListener('ended', onEnded);
                                        // Show redirect message
                                        announceBtn.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Going to Wellness...';
                                        setTimeout(() => {
                                            window.location.href = '/wellness';
                                        }, 1500); // Give user time to see the message
                                    });
                                    
                                    // Fallback: if audio doesn't end properly, redirect after 8 seconds
                                    setTimeout(() => {
                                        if (announceBtn.innerHTML.includes('Announcing')) {
                                            announceBtn.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Going to Wellness...';
                                            setTimeout(() => {
                                                window.location.href = '/wellness';
                                            }, 1500);
                                        }
                                    }, 8000);
                                } else {
                                    // Fallback if no audio element found
                                    setTimeout(() => {
                                        announceBtn.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Going to Wellness...';
                                        setTimeout(() => {
                                            window.location.href = '/wellness';
                                        }, 1500);
                                    }, 3000);
                                }
                            });
                        } else {
                            speakText('You have no pending reminders at this time.', { voiceId: 'en-US-natalie' });
                        }
                    }
                })
                .catch(error => {
                    // Reset button if there's an error
                    announceBtn.innerHTML = originalText;
                    announceBtn.disabled = false;
                });
        }

        // Helper function to create announcement text
        function createAnnouncementText(pendingReminders) {
            if (!pendingReminders || pendingReminders.length === 0) return '';
            
            const now = new Date();
            const overdue = pendingReminders.filter(r => new Date(r.due_date) < now);
            const upcoming = pendingReminders.filter(r => new Date(r.due_date) >= now);
            
            let announcementText = '';
            
            if (overdue.length > 0) {
                announcementText += `You have ${overdue.length} overdue reminder${overdue.length > 1 ? 's' : ''} for your pets. `;
                
                // Add specific overdue reminders (limit to 3 to keep it concise)
                const overdueDetails = overdue.slice(0, 3).map(r => r.title).join(', ');
                if (overdueDetails) {
                    announcementText += `Overdue tasks include: ${overdueDetails}. `;
                }
            }
            
            if (upcoming.length > 0) {
                announcementText += `You have ${upcoming.length} upcoming reminder${upcoming.length > 1 ? 's' : ''} scheduled. `;
                
                // Add specific upcoming reminders (limit to 3 to keep it concise)
                const upcomingDetails = upcoming.slice(0, 3).map(r => r.title).join(', ');
                if (upcomingDetails) {
                    announcementText += `Upcoming tasks include: ${upcomingDetails}. `;
                }
            }
            
            announcementText += 'You will be redirected to the wellness page to manage your reminders.';
            
            return announcementText;
        }

        // Function to clear reminder session storage (called on logout)
        function clearReminderSession() {
            sessionStorage.removeItem('hasAnnouncedReminders');
        }

        // Function to navigate to homepage sections
        function navigateToSection(sectionId) {
            // Store the section to scroll to in sessionStorage
            sessionStorage.setItem('scrollToSection', sectionId);
            // Navigate to homepage
            window.location.href = "{{ url_for('index') }}";
        }

        // Load pets into a specific container
        function loadPets(containerId) {
            fetch('/api/get_pets')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPets(data.pets, containerId);
                    }
                });
        }

        // Display pets in given container
        function displayPets(pets, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (pets.length === 0) {
                container.innerHTML = `
                <div class="col-12">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-paw fa-4x mb-3"></i>
                        <h3>No pets added yet</h3>
                        <p>Add your first pet to start tracking their health</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">
                            <i class="fas fa-plus me-1"></i>Add Your First Pet
                        </button>
                    </div>
                </div>
            `;
                return;
            }

            container.innerHTML = pets.map(pet => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm">
                    ${pet.profile_picture ? `
<div class="text-center pt-3">
    <img src="${pet.profile_picture}" 
         alt="${pet.name}" 
         class="rounded-circle" 
         style="width: 80px; height: 80px; object-fit: cover;">
</div>` : ''}

                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">${pet.name}</h5>
                            <span class="badge bg-primary">${pet.species}</span>
                        </div>
                        <p class="card-text">
                            <strong>Breed:</strong> ${pet.breed}<br>
                            <strong>Age:</strong> ${pet.age} years
                        </p>
                        ${pet.medical_notes ? `<p class="card-text text-muted"><small>${pet.medical_notes}</small></p>` : ''}
                        <div class="btn-group w-100">
                            <a href="/consultation/${pet.id}" class="btn btn-primary btn-sm">
                                <i class="fas fa-video me-1"></i>Consult
                            </a>
                            <a href="/history?pet_id=${pet.id}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-history me-1"></i>History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        }

        // Add pet
        function addPet() {
            const form = document.getElementById('addPetForm');
            const formData = new FormData(form);  // automatically collects all fields + file

            const photoFile = document.getElementById('petPhoto').files[0];

            <!-- const formData = new FormData(); -->
            formData.append('name', document.getElementById('petName').value);
            formData.append('species', document.getElementById('petSpecies').value);
            formData.append('breed', document.getElementById('petBreed').value);
            formData.append('age', document.getElementById('petAge').value);
            formData.append('medical_notes', document.getElementById('petNotes').value);

            if (photoFile) {
                formData.append('profile_picture', photoFile);
            }

            fetch('/api/add_pet', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal and refresh pets
                        bootstrap.Modal.getInstance(document.getElementById('addPetModal')).hide();
                        form.reset();
                        loadPets('petsContainer');   // refresh My Pets
                        loadDashboardData();
                        showNotification('Pet added successfully!', 'success');
                    } else {
                        showNotification('Error adding pet: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error adding pet: ' + error.message, 'error');
                });
        }

        // Start consultation
        function startConsultation() {
            fetch('/api/get_pets')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.pets.length > 0) {
                        if (data.pets.length === 1) {
                            window.location.href = `/consultation/${data.pets[0].id}`;
                        } else {
                            showPetSelectionModal(data.pets, 'consultation');
                        }
                    } else {
                        showNotification('Please add a pet first before starting a consultation.', 'warning');
                    }
                });
        }

        // Pet selection modal
        function showPetSelectionModal(pets, action) {
            const modalHtml = `
            <div class="modal fade" id="petSelectionModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Pet</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Which pet would you like to ${action === 'consultation' ? 'consult about' : 'manage'}?</p>
                            <div class="list-group">
                                ${pets.map(pet => `
                                    <button class="list-group-item list-group-item-action" onclick="selectPet(${pet.id}, '${action}')">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${pet.name}</h6>
                                                <small class="text-muted">${pet.species} • ${pet.breed} • ${pet.age} years</small>
                                            </div>
                                            <i class="fas fa-chevron-right text-muted"></i>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('petSelectionModal'));
            modal.show();

            document.getElementById('petSelectionModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function selectPet(petId, action) {
            bootstrap.Modal.getInstance(document.getElementById('petSelectionModal')).hide();
            if (action === 'consultation') {
                window.location.href = `/consultation/${petId}`;
            }
        }

        // Helper function to show notifications (if you have one in app.js or similar)
        function showNotification(message, type = 'success') {
            const toastEl = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastMessage');

            // reset background classes
            toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning');
            if (type === 'success') {
                toastEl.classList.add('bg-success');
            } else if (type === 'error') {
                toastEl.classList.add('bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('bg-warning');
            }

            toastBody.textContent = message;

            const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); // auto hide in 3s
            toast.show();
        }


        // Placeholder for showDiagnosisExplanation if it's defined elsewhere
        function showDiagnosisExplanation(diagnosis) {
            console.log(`Showing explanation for: ${diagnosis}`);
            // Implement actual logic to show explanation, e.g., in a modal or tooltip
            alert(`Explanation for "${diagnosis}":\n[Detailed explanation would go here]`);
        }

        // Simple dashboard initialization

    </script>

</body>

</html>